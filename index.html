<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <title>LiftLog — Simple Weight Training Tracker (PWA)</title>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --panel: #111827; /* gray-900 */
      --muted: #334155; /* slate-700 */
      --text: #e5e7eb; /* gray-200 */
      --accent: #38bdf8; /* sky-400 */
      --accent-2: #22d3ee; /* cyan-400 */
      --danger: #f87171; /* red-400 */
      --ok: #34d399; /* green-400 */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #1e293b 0, #0b1220 45%, #050913 100%), var(--bg);
      color: var(--text);
    }
    a { color: inherit; text-decoration: none; }
    .app { min-height: 100%; display: grid; grid-template-rows: auto 1fr auto; }
    header { border-bottom: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(8px); position: sticky; top: 0; z-index: 10; }
    .bar { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; max-width: 1100px; margin: 0 auto; }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; letter-spacing: 0.2px; }
    .brand .logo { width: 28px; height: 28px; border-radius: 8px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); display: inline-block; }
    nav { display: flex; gap: 10px; align-items: center; }
    nav a { padding: 8px 10px; border-radius: 10px; color: #cbd5e1; }
    nav a.active { background: rgba(56, 189, 248, 0.15); color: white; }
    main { max-width: 1100px; margin: 0 auto; padding: 24px 18px 50px; }
    .panel { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .stack { display: grid; gap: 16px; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .card { padding: 16px; border-radius: 16px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); }
    .muted { color: #94a3b8; }
    .headline { font-size: clamp(22px, 3vw, 30px); font-weight: 800; letter-spacing: 0.2px; margin: 0; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); color: white; cursor: pointer; }
    .btn:hover { border-color: rgba(56,189,248,0.45); }
    .btn.primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); border: none; color: #041014; }
    .btn.danger { background: rgba(248,113,113,0.15); border-color: rgba(248,113,113,0.35); color: #fecaca; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    form .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { font-size: 12px; color: #a3b2c7; display: block; margin-bottom: 6px; }
    input, select, textarea { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.02); color: #e5e7eb; }
    input::placeholder { color: #64748b; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px 12px; border-bottom: 1px dashed rgba(255,255,255,0.08); vertical-align: top; }
    th { font-size: 12px; color: #8aa0bd; font-weight: 600; }
    tbody tr:hover { background: rgba(255,255,255,0.03); }
    .chip { padding: 4px 8px; font-size: 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12); color: #cbd5e1; white-space: nowrap; }
    .footer { color: #90a4c1; font-size: 12px; text-align: center; padding: 22px 10px; }
    .notice { position: fixed; right: 16px; bottom: 16px; padding: 12px 14px; border-radius: 12px; background: rgba(0,0,0,0.65); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.18); color: #e5e7eb; opacity: 0; transform: translateY(10px); transition: all .3s ease; pointer-events: none; }
    .notice.show { opacity: 1; transform: translateY(0); }
    details summary { cursor: pointer; }
    @media (max-width: 780px) {
      form .row { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
      nav { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="bar">
        <div class="brand"><span class="logo" aria-hidden="true"></span> <span>LiftLog</span></div>
        <nav aria-label="Primary">
          <a href="#/sessions" id="nav-sessions">Sessions</a>
          <a href="#/exercises" id="nav-exercises">Exercises</a>
          <a href="#/stats" id="nav-stats">Stats</a>
          <a href="#/about" id="nav-about">About</a>
          <button class="btn" id="installBtn" style="display:none;">Install App</button>
        </nav>
      </div>
    </header>

    <main id="app"></main>

    <footer class="footer">LiftLog stores everything in your browser (localStorage). Export CSV any time.</footer>
  </div>

  <div id="notice" class="notice" role="status" aria-live="polite"></div>
  <div id="timerToast" class="notice" role="status" aria-live="polite" style="left:16px; right:auto;"></div>

  <script>
    // --- Tiny utilities -------------------------------------------------------
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const notice = (msg, ms=1600) => { const n = $('#notice'); n.textContent = msg; n.classList.add('show'); setTimeout(()=>n.classList.remove('show'), ms); };
    const todayISO = () => new Date().toISOString().slice(0,10);

    // Parse hash path & query (e.g. #/session?id=abc)
    function parseHash(){
      const raw = location.hash.replace('#','') || '/sessions';
      const [path, queryStr] = raw.split('?');
      const q = Object.fromEntries(new URLSearchParams(queryStr || ''));
      return { path, q };
    }

    // CSV helper
    function toCSV(rows, cols){
      const head = cols.join(',');
      const data = rows.map(r => cols.map(k => JSON.stringify(r[k] ?? '')).join(',')).join('
');
      return head + '
' + data + '
';
    }
    function download(content, filename, mime){
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    // --- Store ----------------------------------------------------------------
    const Store = {
      KEY: 'liftlog:v1',
      data: {
        exercises: [
          // { id, name, muscle }
        ],
        sessions: [
          // { id, date, notes, done: bool, items: [ { exerciseId, sets: [ { weight, reps } ] } ] }
        ]
      },
      load(){
        try { const raw = localStorage.getItem(this.KEY); if (raw) this.data = JSON.parse(raw); } catch(e){ console.warn('store parse fail', e); }
      },
      save(){ localStorage.setItem(this.KEY, JSON.stringify(this.data)); },
      reset(){ this.data = { exercises: [], sessions: [] }; this.save(); }
    };
    Store.load();

    // --- Domain helpers -------------------------------------------------------
    const MUSCLES = ['Chest','Back','Shoulders','Biceps','Triceps','Legs','Glutes','Core','Calves','Other'];

    function uid(){ return Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4); }
    function getExercise(id){ return Store.data.exercises.find(e => e.id === id); }
    function getSession(id){ return Store.data.sessions.find(s => s.id === id); }

    function upsertSessionItem(session, exerciseId){
      let item = session.items.find(i => i.exerciseId === exerciseId);
      if (!item){ item = { exerciseId, sets: [] }; session.items.push(item); }
      return item;
    }

    // Compute stats
    function computeStats(){
      const byExercise = {};
      const byMuscle = {};
      for (const s of Store.data.sessions){
        for (const it of s.items){
          const ex = getExercise(it.exerciseId); if(!ex) continue;
          const key = ex.id;
          const ms = ex.muscle || 'Other';
          if(!byExercise[key]) byExercise[key] = { exerciseId: ex.id, name: ex.name, muscle: ex.muscle, sets: 0, reps: 0, maxWeight: 0 };
          for (const set of it.sets){
            byExercise[key].sets += 1;
            byExercise[key].reps += Number(set.reps)||0;
            byExercise[key].maxWeight = Math.max(byExercise[key].maxWeight, Number(set.weight)||0);
            if(!byMuscle[ms]) byMuscle[ms] = { muscle: ms, sets: 0, reps: 0 };
            byMuscle[ms].sets += 1; byMuscle[ms].reps += Number(set.reps)||0;
          }
        }
      }
      return { byExercise: Object.values(byExercise), byMuscle: Object.values(byMuscle) };
    }

    // --- Router ---------------------------------------------------------------
    const Router = {
      routes: {},
      go(path){ location.hash = path; },
      on(path, fn){ this.routes[path] = fn; },
      start(){
        const handle = () => {
          const { path } = parseHash();
          $$('#nav-sessions, #nav-exercises, #nav-stats, #nav-about').forEach(a => a.classList.remove('active'));
          const active = $('#nav-' + (path.split('/')[1] || 'sessions')); if (active) active.classList.add('active');
          const view = this.routes[path] || Views.NotFound; $('#app').replaceChildren(view());
        };
        window.addEventListener('hashchange', handle); handle();
      }
    };

    // --- Views ----------------------------------------------------------------
    const Views = {
      Sessions(){
        const wrap = document.createElement('div');
        wrap.className = 'stack';
        wrap.innerHTML = `
          <section class="panel card stack" aria-labelledby="s-h1">
            <div style="display:flex; align-items:center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
              <h1 id="s-h1" class="headline" style="margin:0;">Training Sessions</h1>
              <div class="stack" style="grid-auto-flow: column; gap: 8px; display:grid;">
                <button class="btn primary" id="start">Start new session</button>
                <button class="btn" id="export">Export all sessions (CSV)</button>
              </div>
            </div>
            <div class="card">
              <table role="table" aria-label="Sessions table">
                <thead><tr><th>Date</th><th>Notes</th><th>Status</th><th>Exercises</th><th>Sets</th><th style="width:1%">Actions</th></tr></thead>
                <tbody id="tbody"></tbody>
              </table>
              <p id="empty" class="muted" style="display:none; text-align:center; margin: 12px 0;">No sessions yet. Start one above.</p>
            </div>
          </section>
        `;

        const tbody = $('#tbody', wrap);
        const empty = $('#empty', wrap);
        render();

        function render(){
          tbody.innerHTML = '';
          const sessions = [...Store.data.sessions].sort((a,b)=> (b.date||'').localeCompare(a.date||''));
          empty.style.display = sessions.length ? 'none' : 'block';
          for (const s of sessions){
            const counts = { exercises: s.items.length, sets: s.items.reduce((t,i)=> t + i.sets.length, 0) };
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><span class="chip">${s.date || ''}</span></td>
              <td class="muted">${(s.notes||'')}</td>
              <td>${s.done ? '<span class="chip">Done</span>' : '<span class="chip">In progress</span>'}</td>
              <td>${counts.exercises}</td>
              <td>${counts.sets}</td>
              <td><a class="btn" href="#/session?id=${s.id}">Open</a> <button class="btn danger" data-del="${s.id}">Delete</button></td>
            `;
            tbody.appendChild(tr);
          }
        }

        $('#start', wrap).addEventListener('click', () => {
          const s = { id: uid(), date: todayISO(), notes: '', done: false, items: [] };
          Store.data.sessions.push(s); Store.save(); notice('Session started'); Router.go('/session?id=' + s.id);
        });

        wrap.addEventListener('click', (e) => {
          const id = e.target?.dataset?.del; if(!id) return;
          if(confirm('Delete this session?')){ Store.data.sessions = Store.data.sessions.filter(x=>x.id!==id); Store.save(); render(); notice('Session deleted'); }
        });

        $('#export', wrap).addEventListener('click', () => {
          const flat = [];
          for (const s of Store.data.sessions){
            for (const it of s.items){
              const ex = getExercise(it.exerciseId) || { name:'(deleted)', muscle:'Other' };
              for (const set of it.sets){
                flat.push({ date: s.date, sessionId: s.id, exercise: ex.name, muscle: ex.muscle||'Other', weight: set.weight, reps: set.reps });
              }
            }
          }
          download(toCSV(flat, ['date','sessionId','exercise','muscle','weight','reps']), 'liftlog_sessions.csv', 'text/csv');
          notice('Exported sessions CSV');
        });

        return wrap;
      },

      SessionDetail(){
        const { q } = parseHash();
        const s = getSession(q.id);
        const wrap = document.createElement('div');
        if(!s){ wrap.innerHTML = `<div class="panel card" style="padding:18px;">Session not found. <a href="#/sessions">Back to sessions</a>.</div>`; return wrap; }

        wrap.className = 'stack';
        wrap.innerHTML = `
          <section class="panel card stack" aria-labelledby="sd-h1">
            <div style="display:flex; align-items:center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
              <h1 id="sd-h1" class="headline" style="margin:0;">Session — ${s.date}</h1>
              <div class="stack" style="grid-auto-flow: column; gap: 8px; display:grid;">
                <button class="btn" id="export">Export (CSV)</button>
                ${s.done ? '' : '<button class="btn primary" id="finish">Finish Session</button>'}
                <a class="btn" href="#/sessions">Back</a>
              </div>
            </div>
            <form id="meta" class="stack">
              <div class="row">
                <div>
                  <label for="date">Date</label>
                  <input id="date" type="date" value="${s.date}" />
                </div>
                <div>
                  <label for="notes">Notes</label>
                  <input id="notes" placeholder="Optional" value="${s.notes||''}" />
                </div>
              </div>
            </form>

            <div class="card stack">
              <h3>Add exercise & set</h3>
              <form id="add" class="stack">
                <div class="row">
                  <div>
                    <label for="exercise">Exercise</label>
                    <select id="exercise"></select>
                  </div>
                  <div>
                    <label for="weight">Weight</label>
                    <input id="weight" type="number" step="0.5" min="0" placeholder="kg" />
                  </div>
                </div>
                <div class="row">
                  <div>
                    <label for="reps">Reps</label>
                    <input id="reps" type="number" step="1" min="1" placeholder="e.g. 8" />
                  </div>
                  <div style="display:flex; align-items:end; gap:8px;">
                    <button class="btn primary" type="submit">Add set</button>
                    <button class="btn" type="button" id="startTimer">Start 120s timer</button>
                    <span class="chip" id="timerDisplay">120s</span>
                  </div>
                </div>
              </form>
            </div>

            <div id="blocks" class="stack"></div>
          </section>
        `;

        // Timer state
        let tLeft = 120; let tId = null; const tDisp = $('#timerDisplay', wrap);
        function tick(){ tLeft -= 1; if(tLeft < 0){ clearInterval(tId); tId=null; tLeft=0; onTimerEnd(); } renderTimer(); }
        function renderTimer(){ tDisp.textContent = tLeft + 's'; }
        function startTimer(){ if(tId) clearInterval(tId); tLeft = 120; renderTimer(); tId = setInterval(tick, 1000); toastTimer('Timer started: 120s'); }
        function stopTimer(){ if(tId) { clearInterval(tId); tId=null; toastTimer('Timer stopped'); } }
        function onTimerEnd(){ toastTimer('Rest done — lift!'); try{ navigator.vibrate?.(200); }catch{} beep(); }
        function toastTimer(msg){ const el = $('#timerToast'); el.textContent = msg; el.classList.add('show'); setTimeout(()=> el.classList.remove('show'), 1800); }
        function beep(){ try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.frequency.value = 880; g.gain.value = 0.05; o.start(); setTimeout(()=>{ o.stop(); ctx.close(); }, 300); }catch{} }

        $('#startTimer', wrap).addEventListener('click', startTimer);

        const exerciseSelect = $('#exercise', wrap);
        function refreshExerciseOptions(){
          exerciseSelect.innerHTML = Store.data.exercises.length ? '' : '<option value="">No exercises — add some first</option>';
          for (const ex of Store.data.exercises){
            const opt = document.createElement('option'); opt.value = ex.id; opt.textContent = `${ex.name} (${ex.muscle||'Other'})`; exerciseSelect.appendChild(opt);
          }
        }
        refreshExerciseOptions();

        const blocks = $('#blocks', wrap);
        function renderBlocks(){
          blocks.innerHTML = '';
          for (const it of s.items){
            const ex = getExercise(it.exerciseId) || { name:'(deleted)', muscle:'Other' };
            const div = document.createElement('div');
            div.className = 'card stack';
            const max = Math.max(0, ...it.sets.map(x=>Number(x.weight)||0));
            const totalReps = it.sets.reduce((t,x)=>t+(Number(x.reps)||0),0);
            div.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
                <div>
                  <strong>${ex.name}</strong> <span class="chip">${ex.muscle}</span>
                  <span class="muted" style="margin-left:8px;">${it.sets.length} sets • ${totalReps} reps • max ${max}kg</span>
                </div>
                <div>
                  <button class="btn" data-addset="${it.exerciseId}">Add set</button>
                  <button class="btn danger" data-delblock="${it.exerciseId}">Remove exercise</button>
                </div>
              </div>
              <table role="table" aria-label="Sets table">
                <thead><tr><th>#</th><th>Weight (kg)</th><th>Reps</th><th style="width:1%">Actions</th></tr></thead>
                <tbody>
                  ${it.sets.map((st,idx)=>`<tr><td>${idx+1}</td><td>${st.weight}</td><td>${st.reps}</td><td><button class="btn danger" data-dels="${it.exerciseId}:${idx}">Delete</button></td></tr>`).join('')}
                </tbody>
              </table>
            `;
            blocks.appendChild(div);
          }
        }
        renderBlocks();

        // Meta change
        $('#meta', wrap).addEventListener('input', () => {
          s.date = $('#date', wrap).value || s.date;
          s.notes = $('#notes', wrap).value || '';
          Store.save();
        });

        // Add set
        $('#add', wrap).addEventListener('submit', (e) => {
          e.preventDefault();
          const exId = exerciseSelect.value; if(!exId) return notice('Pick an exercise');
          const weight = Number($('#weight', wrap).value); const reps = Number($('#reps', wrap).value);
          if(!Number.isFinite(weight) || weight < 0) return notice('Enter weight');
          if(!Number.isInteger(reps) || reps <= 0) return notice('Enter reps');
          const item = upsertSessionItem(s, exId); item.sets.push({ weight, reps });
          Store.save(); $('#weight', wrap).value=''; $('#reps', wrap).value=''; renderBlocks(); notice('Set added');
          startTimer();
        });

        // Block-level actions
        blocks.addEventListener('click', (e) => {
          const addId = e.target?.dataset?.addset; if(addId){
            const w = Number(prompt('Weight (kg)','0')); const r = Number(prompt('Reps','8'));
            if(Number.isFinite(w) && Number.isFinite(r) && r>0){ upsertSessionItem(s, addId).sets.push({ weight:w, reps:r }); Store.save(); renderBlocks(); notice('Set added'); startTimer(); }
          }
          const delBlock = e.target?.dataset?.delblock; if(delBlock){
            if(confirm('Remove this exercise from session?')){ s.items = s.items.filter(i=>i.exerciseId!==delBlock); Store.save(); renderBlocks(); notice('Exercise removed'); }
          }
          const delSet = e.target?.dataset?.dels; if(delSet){
            const [exId, idxStr] = delSet.split(':'); const idx = Number(idxStr);
            const item = s.items.find(i=>i.exerciseId===exId); if(item && item.sets[idx]){ item.sets.splice(idx,1); Store.save(); renderBlocks(); notice('Set deleted'); }
          }
        });

        $('#finish', wrap)?.addEventListener('click', () => { s.done = true; Store.save(); notice('Session finished'); Router.go('/sessions'); });

        $('#export', wrap).addEventListener('click', () => {
          const flat = [];
          for (const it of s.items){
            const ex = getExercise(it.exerciseId) || { name:'(deleted)', muscle:'Other' };
            for (const set of it.sets){ flat.push({ date: s.date, exercise: ex.name, muscle: ex.muscle||'Other', weight: set.weight, reps: set.reps }); }
          }
          download(toCSV(flat, ['date','exercise','muscle','weight','reps']), `session_${s.date}.csv`, 'text/csv'); notice('Session CSV exported');
        });

        return wrap;
      },

      Exercises(){
        const wrap = document.createElement('div');
        wrap.className = 'stack';
        wrap.innerHTML = `
          <section class="panel card stack" aria-labelledby="e-h1">
            <div style="display:flex; align-items:center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
              <h1 id="e-h1" class="headline" style="margin:0;">Exercises Catalogue</h1>
              <div class="stack" style="grid-auto-flow: column; gap: 8px; display:grid;">
                <button class="btn" id="seed">Seed common lifts</button>
                <button class="btn" id="export">Export (CSV)</button>
              </div>
            </div>

            <form id="addEx" class="stack">
              <div class="row">
                <div>
                  <label for="exName">Name</label>
                  <input id="exName" placeholder="e.g. Bench Press" required />
                </div>
                <div>
                  <label for="exMuscle">Muscle group</label>
                  <select id="exMuscle"></select>
                </div>
              </div>
              <div style="display:flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn primary" type="submit">Add Exercise</button>
              </div>
            </form>

            <div class="card">
              <table role="table" aria-label="Exercises table">
                <thead><tr><th>Name</th><th>Muscle</th><th style="width:1%">Actions</th></tr></thead>
                <tbody id="tbody"></tbody>
              </table>
              <p id="empty" class="muted" style="display:none; text-align:center; margin: 12px 0;">No exercises yet. Add some above.</p>
            </div>
          </section>
        `;

        const sel = $('#exMuscle', wrap);
        for (const m of MUSCLES){ const o = document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o); }

        const tbody = $('#tbody', wrap);
        const empty = $('#empty', wrap);
        function render(){
          tbody.innerHTML='';
          const list = [...Store.data.exercises].sort((a,b)=>a.name.localeCompare(b.name));
          empty.style.display = list.length ? 'none' : 'block';
          for (const ex of list){
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${ex.name}</td><td><span class="chip">${ex.muscle}</span></td><td><button class="btn" data-edit="${ex.id}">Edit</button> <button class="btn danger" data-del="${ex.id}">Delete</button></td>`;
            tbody.appendChild(tr);
          }
        }
        render();

        $('#addEx', wrap).addEventListener('submit', (e)=>{
          e.preventDefault();
          const name = $('#exName', wrap).value.trim(); const muscle = $('#exMuscle', wrap).value;
          if(!name) return notice('Name required');
          Store.data.exercises.push({ id: uid(), name, muscle }); Store.save(); $('#exName', wrap).value=''; render(); notice('Exercise added');
        });

        wrap.addEventListener('click', (e)=>{
          const del = e.target?.dataset?.del; if(del){
            if(confirm('Delete exercise? Existing session data will keep the name as (deleted).')){
              Store.data.exercises = Store.data.exercises.filter(x=>x.id!==del); Store.save(); render(); notice('Exercise deleted');
            }
          }
          const edit = e.target?.dataset?.edit; if(edit){
            const ex = getExercise(edit); if(!ex) return;
            const nn = prompt('Exercise name', ex.name); if(nn===null) return;
            const mm = prompt('Muscle group', ex.muscle||'Other');
            ex.name = (nn||ex.name).trim(); ex.muscle = (mm||ex.muscle).trim(); Store.save(); render(); notice('Exercise updated');
          }
        });

        $('#seed', wrap).addEventListener('click', () => {
          const seeds = [
            ['Bench Press','Chest'],['Incline DB Press','Chest'],['Lat Pulldown','Back'],['Barbell Row','Back'],
            ['Shoulder Press','Shoulders'],['Lateral Raise','Shoulders'],['Bicep Curl','Biceps'],['Triceps Pushdown','Triceps'],
            ['Back Squat','Legs'],['Romanian Deadlift','Glutes'],['Leg Press','Legs'],['Hanging Leg Raise','Core']
          ];
          const have = new Set(Store.data.exercises.map(e=>e.name.toLowerCase()));
          for (const [n,m] of seeds){ if(!have.has(n.toLowerCase())) Store.data.exercises.push({ id: uid(), name:n, muscle:m }); }
          Store.save(); render(); notice('Seeded common lifts');
        });

        $('#export', wrap).addEventListener('click', ()=>{
          download(toCSV(Store.data.exercises, ['id','name','muscle']), 'liftlog_exercises.csv', 'text/csv'); notice('Exercises CSV exported');
        });

        return wrap;
      },

      Stats(){
        const wrap = document.createElement('div');
        wrap.className = 'stack';
        const { byExercise, byMuscle } = computeStats();
        wrap.innerHTML = `
          <section class="panel card stack" aria-labelledby="st-h1">
            <div style="display:flex; align-items:center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
              <h1 id="st-h1" class="headline" style="margin:0;">Stats</h1>
              <div class="stack" style="grid-auto-flow: column; gap: 8px; display:grid;">
                <button class="btn" id="exportEx">Export by exercise (CSV)</button>
                <button class="btn" id="exportMu">Export by muscle (CSV)</button>
              </div>
            </div>

            <div class="grid">
              <div class="card" style="grid-column: span 7;">
                <h3>By Exercise</h3>
                <table role="table" aria-label="By exercise table">
                  <thead><tr><th>Exercise</th><th>Muscle</th><th>Sets</th><th>Reps</th><th>Max Weight (kg)</th></tr></thead>
                  <tbody id="exBody">${byExercise.map(r=>`<tr><td>${r.name}</td><td><span class="chip">${r.muscle}</span></td><td>${r.sets}</td><td>${r.reps}</td><td>${r.maxWeight}</td></tr>`).join('')}</tbody>
                </table>
                ${byExercise.length?'' : '<p class="muted">No data yet — do a session.</p>'}
              </div>
              <div class="card" style="grid-column: span 5;">
                <h3>By Muscle Group</h3>
                <table role="table" aria-label="By muscle table">
                  <thead><tr><th>Muscle</th><th>Sets</th><th>Reps</th></tr></thead>
                  <tbody id="muBody">${byMuscle.map(r=>`<tr><td><span class="chip">${r.muscle}</span></td><td>${r.sets}</td><td>${r.reps}</td></tr>`).join('')}</tbody>
                </table>
                ${byMuscle.length?'' : '<p class="muted">No data yet — do a session.</p>'}
              </div>
            </div>
          </section>
        `;

        $('#exportEx', wrap).addEventListener('click', ()=>{
          download(toCSV(computeStats().byExercise, ['name','muscle','sets','reps','maxWeight']), 'liftlog_stats_by_exercise.csv', 'text/csv'); notice('Exported by-exercise');
        });
        $('#exportMu', wrap).addEventListener('click', ()=>{
          download(toCSV(computeStats().byMuscle, ['muscle','sets','reps']), 'liftlog_stats_by_muscle.csv', 'text/csv'); notice('Exported by-muscle');
        });

        return wrap;
      },

      About(){
        const wrap = document.createElement('div');
        wrap.className = 'stack';
        wrap.innerHTML = `
          <section class="panel card stack">
            <h1 class="headline" style="margin:0;">About LiftLog</h1>
            <p class="muted">A single-file weight training tracker. Catalogue your exercises, run sessions, log sets, and see stats — all in your browser.</p>
            <details class="card"><summary>Data model</summary>
              <pre class="muted" style="white-space:pre-wrap;">{
  exercises: [{ id, name, muscle }],
  sessions: [{ id, date, notes, done, items: [ { exerciseId, sets: [ { weight, reps } ] } ] }]
}</pre>
            </details>
            <div class="card">
              <button class="btn" id="reset">Reset all data</button>
            </div>
            <div class="card">
              <h3>Install on mobile</h3>
              <p class="muted">On Android Chrome/Edge you should see an <em>Install App</em> button in the top nav when eligible. On iPhone Safari: share icon → <strong>Add to Home Screen</strong>.</p>
            </div>
          </section>
        `;
        $('#reset', wrap).addEventListener('click', () => { if(confirm('This will erase everything.')) { Store.reset(); notice('Data cleared'); Router.go('/exercises'); } });
        return wrap;
      },

      NotFound(){ const div = document.createElement('div'); div.innerHTML = `<div class="panel card" style="padding:18px;">Route not found. <a href="#/sessions">Go to sessions</a>.</div>`; return div; }
    };

    // --- Routes ---------------------------------------------------------------
    Router.on('/sessions', Views.Sessions);
    Router.on('/session', Views.SessionDetail);
    Router.on('/exercises', Views.Exercises);
    Router.on('/stats', Views.Stats);
    Router.on('/about', Views.About);

    // --- PWA manifest & service worker (inlined) -------------------------------
    (function setupPWA(){
      try {
        // Create icons via canvas so we have real URLs
        function makeIcon(size){
          const c = document.createElement('canvas'); c.width=c.height=size; const x=c.getContext('2d');
          x.fillStyle='#0f172a'; x.fillRect(0,0,size,size);
          x.fillStyle='#22d3ee'; x.beginPath(); x.arc(size*0.5,size*0.5,size*0.38,0,Math.PI*2); x.fill();
          x.fillStyle='#041014'; x.font = Math.floor(size*0.42)+'px system-ui'; x.textAlign='center'; x.textBaseline='middle'; x.fillText('L', size*0.5, size*0.54);
          return new Promise(res=> c.toBlob(b=> res(URL.createObjectURL(b)), 'image/png') );
        }
        Promise.all([makeIcon(192), makeIcon(512)]).then(([i192,i512])=>{
          const manifest = {
            name: 'LiftLog', short_name: 'LiftLog',
            start_url: '.', display: 'standalone', background_color: '#0f172a', theme_color: '#0f172a',
            icons: [ { src: i192, sizes:'192x192', type:'image/png' }, { src: i512, sizes:'512x512', type:'image/png' } ]
          };
          const mBlob = new Blob([JSON.stringify(manifest)], { type:'application/json' });
          const mUrl = URL.createObjectURL(mBlob);
          const link = document.createElement('link'); link.rel='manifest'; link.href=mUrl; document.head.appendChild(link);
        });

        // Service worker contents
        const swCode = `
          const CACHE = 'liftlog-cache-v1';
          self.addEventListener('install', (e)=>{ self.skipWaiting(); e.waitUntil(caches.open(CACHE)); });
          self.addEventListener('activate', (e)=>{ e.waitUntil(self.clients.claim()); });
          self.addEventListener('fetch', (e)=>{
            const req = e.request;
            if (req.method !== 'GET') return;
            e.respondWith(
              caches.match(req).then(hit => {
                const fetcher = fetch(req).then(res => { const copy = res.clone(); caches.open(CACHE).then(c=> c.put(req, copy)); return res; }).catch(()=> hit);
                return hit || fetcher;
              })
            );
          });
        `;
        const swUrl = URL.createObjectURL(new Blob([swCode], { type:'text/javascript' }));
        if ('serviceWorker' in navigator) navigator.serviceWorker.register(swUrl);
      } catch(e){ console.warn('PWA setup error', e); }
    })();

    // --- Add to Home Screen (A2HS) button -----------------------------------
    (function setupA2HS(){
      const btn = document.getElementById('installBtn');
      let deferred;
      window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferred = e; btn.style.display='inline-flex'; });
      btn?.addEventListener('click', async ()=>{ if(!deferred) return; deferred.prompt(); const { outcome } = await deferred.userChoice; notice('Install: '+ outcome); deferred = null; btn.style.display='none'; });
    })();

    // --- Boot -----------------------------------------------------------------
    if(!Store.data.exercises.length && !Store.data.sessions.length){
      // First-run hint: seed a few common exercises for convenience
      Store.data.exercises.push(
        { id: uid(), name: 'Bench Press', muscle: 'Chest' },
        { id: uid(), name: 'Lat Pulldown', muscle: 'Back' },
        { id: uid(), name: 'Shoulder Press', muscle: 'Shoulders' }
      );
      Store.save();
    }
    Router.start();
  </script>
</body>
</html>
